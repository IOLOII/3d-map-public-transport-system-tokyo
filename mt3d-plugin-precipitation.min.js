/*!
 * mt3d-plugin-precipitation v1.1.0
 * https://minitokyo3d.com
 * (c) 2021-2022 Akihiko Kusanagi
 * Released under the MIT license
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("mini-tokyo-3d")):"function"==typeof define&&define.amd?define(["mini-tokyo-3d"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).mt3dPrecipitation=t(e.mt3d)}(this,(function(e){"use strict";const{Evented:t,MercatorCoordinate:o}=e.mapboxgl,{AmbientLight:i,BoxGeometry:r,BufferAttribute:a,Camera:s,Color:n,DirectionalLight:l,DoubleSide:h,Group:c,InstancedBufferGeometry:m,InstancedMesh:p,InstancedBufferAttribute:d,Matrix4:f,Mesh:u,MeshLambertMaterial:_,RawShaderMaterial:v,Scene:w,Vector4:y,WebGLRenderer:M}=e.THREE;var g={noaa:{scale:[{value:0,color:"#000000"},{value:5,color:"#69E5E4"},{value:10,color:"#4599E9"},{value:15,color:"#0F02E7"},{value:20,color:"#72F44A"},{value:25,color:"#59C239"},{value:30,color:"#3E8B27"},{value:35,color:"#F8F551"},{value:40,color:"#DDBC3F"},{value:45,color:"#EA9736"},{value:50,color:"#E33323"},{value:55,color:"#BF281C"},{value:60,color:"#A72318"},{value:65,color:"#E131F0"},{value:70,color:"#8D54BF"},{value:75,color:"#FEFEFE"}],align:"center"}},x={jma:{type:"raster",tiles:["https://www.jma.go.jp/bosai/jmatile/data/nowc/${[0].basetime}/none/${[0].validtime}/surf/hrpns/{z}/{x}/{y}.png"],tileSize:256,minzoom:0,maxzoom:10,attribution:'<a href="https://www.jma.go.jp">© Japan Meteorological Agency</a>',catalog:"https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json",interval:3e5,colors:["#000000","#F2F2FF","#A0D2FF","#218CFF","#0041FF","#FAF500","#FF9900","#FF2800","#B40068"],timestamp:"${[0].basetime}"},rainviewer:{type:"raster",tiles:["${host}${radar.past[-1].path}/256/{z}/{x}/{y}/0/0_1.png"],tileSize:256,minzoom:1,maxzoom:20,attribution:'<a href="https://www.rainviewer.com">© RainViewer</a>',catalog:"https://api.rainviewer.com/public/weather-maps.json",interval:6e5,timestamp:"${radar.past[-1].time}"}};const b=new r(1,-1,1);b.translate(.5,.5,.5);const z=new Float32Array([-.002,.002,.01,.002,.002,.01,-.002,.002,-.01,.002,.002,-.01,-.002,-.002,.01,-.002,.002,.01,-.002,-.002,-.01,-.002,.002,-.01,-.002,.002,.01,.002,.002,.01,-.002,-.002,.01,.002,-.002,.01]),C=new Uint16Array([0,1,2,2,1,3,4,5,6,6,5,7,8,9,10,10,9,11]),F=new Float32Array([-.004,.004,.001,.004,.004,.001,-.004,.004,-.001,.004,.004,-.001,-.004,-.004,.001,-.004,.004,.001,-.004,-.004,-.001,-.004,.004,-.001,-.004,.004,.001,.004,.004,.001,-.004,-.004,.001,.004,-.004,.001]),L=new Uint16Array([0,1,2,2,1,3,4,5,6,6,5,7,8,9,10,10,9,11]),A="\n    precision highp float;\n    uniform mat4 modelViewMatrix;\n    uniform mat4 projectionMatrix;\n    uniform float time;\n    uniform float scale;\n    attribute vec3 position;\n    attribute vec3 offset;\n\n    void main(void) {\n        vec3 translate = vec3(position.x * scale + offset.x, position.y * scale + offset.y, position.z + mod(offset.z - time + 1.0, 1.0));\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(translate, 1.0);\n    }\n",S="\n    precision highp float;\n    uniform vec4 color;\n\n    void main(void) {\n        gl_FragColor = color;\n    }\n";function E(e,t){return void 0===e?t:e}function R(e,t){let o=t.split(/\.|(?=\[)/)[0];const i=t.slice(o.length).replace(/^\./,"");return Array.isArray(e)&&o.match(/^\[-?\d+\]$/)&&(o=+o.slice(1,-1),o<0&&(o+=e.length)),o in e&&i?R(e[o],i):e[o]}function B(e,t){const o=e.match(/\$\{[^}]+\}/g);if(o)for(const i of o)e=e.replace(i,R(t,i.slice(2,-1)));return e}function I(e,t,o,i,r,s){const n=1/Math.pow(2,(e-1)/3),l=Math.floor(64*n),h=Math.floor(64*n),c=i[0][0],p=[];for(let t=0;t<h;t++)for(let i=0;i<l;i++){const r=o[256*Math.floor((t+.5)/h*256)+Math.floor((i+.5)/l*256)];if(!s==!(128&r)&&(127&r)>=c)for(let o=0;o<Math.pow(2,((127&r)-c)/10)*Math.max(1,e-14);o++)p.push({x:i,y:t})}if(0===p.length)return;const f=new m,_=new a(s?F:z,3);f.setAttribute("position",_),f.setIndex(new a(s?L:C,1));const v=new Float32Array(3*p.length),w=new d(v,3);for(let e=0;e<p.length;e++){const{x:t,y:o}=p[e];w.setXYZ(e,(t+Math.random())/l,(o+Math.random())/h,Math.random())}f.setAttribute("offset",w);const y=new u(f,r);return y.position.x=t.x,y.position.y=t.y,y.scale.x=t.dx,y.scale.y=t.dy,y.scale.z=2e-4*Math.pow(2,e<10?10-e:e<14?0:.8*(14-e)),y.updateMatrix(),y.matrixAutoUpdate=!1,y.frustumCulled=!1,y}function $(e){e.geometry instanceof m&&e.geometry.dispose(),e instanceof p&&e.dispose()}function j(e,t){this.constructor.prototype.loadTile.call(this,e,(i=>{const{x:r,y:a,z:s}=e.tileID.canonical,n=`${s}/${r}/${a}`,l=e.texture,h=this._parentLayer,c=this._tileDict;if(l&&h&&!c[n]){const t=this.map.painter.context.gl,i=t.createFramebuffer(),[r,a]=l.size,m=new Uint8Array(r*a*4),d=e._dbz=new Uint8Array(r*a),u=e._mercatorBounds=function(e){const{x:t,y:i,z:r}=e,a=Math.pow(2,r),s=t/a*360-180,n=180*Math.atan(Math.sinh(Math.PI*(1-2*i/a)))/Math.PI,l=(t+1)/a*360-180,h=180*Math.atan(Math.sinh(Math.PI*(1-2*(i+1)/a)))/Math.PI,c=o.fromLngLat([s,n]),m=o.fromLngLat([l,h]);return{x:c.x,y:c.y,dx:m.x-c.x,dy:m.y-c.y}}(e.tileID.canonical);if(t.bindFramebuffer(t.FRAMEBUFFER,i),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,l.texture,0),t.readPixels(0,0,r,a,t.RGBA,t.UNSIGNED_BYTE,m),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(i),h._colors){const e=h._colors.map((e=>parseInt(e.replace("#","0x"),16)));for(let t=0;t<d.length;t++){const o=256*(256*m[4*t]+m[4*t+1])+m[4*t+2];for(let i=0;i<e.length;i++)if(o===o[i]){d[t]=i;break}}}else for(let e=0;e<d.length;e++)d[e]=m[4*e];const _=h._zoomGroups[s-1],v=function(e,t,o,i,r){const a=1/Math.pow(2,(e-1)/3),s=Math.floor(64*a),n=Math.floor(64*a),l=i[0][0],h=[];for(let e=0;e<n;e++)for(let t=0;t<s;t++){const r=127&o[256*Math.floor((e+.5)/n*256)+Math.floor((t+.5)/s*256)];if(r>=l)for(let o=1;o<i.length;o++)if(r<i[o][0]){h.push({x:t,y:e,p:o});break}}if(0===h.length)return;const c=new p(b,r,h.length);for(let e=0;e<h.length;e++){const{x:t,y:o,p:r}=h[e],a=(new f).makeScale(1/s,1/n,1).setPosition(t/s,o/n,0);c.setMatrixAt(e,a),c.setColorAt(e,i[r][1])}return c.position.x=t.x,c.position.y=t.y,c.scale.x=t.dx,c.scale.y=t.dy,c.scale.z=2e-4*Math.pow(2,e<10?10-e:e<14?0:.8*(14-e)),c.updateMatrix(),c.matrixAutoUpdate=!1,c.renderOrder=1,c}(s,u,d,h._scaleColors,h._meshMaterial);v&&(e._boxMesh=v,_.add(v));const w=I(s,u,d,h._scaleColors,h._rainMaterial);w&&(e._rainMesh=w,_.add(w));const y=I(s,u,d,h._scaleColors,h._snowMaterial,!0);y&&(e._snowMesh=y,_.add(y)),c[n]=e}t(i)}))}function D(e,t){this.constructor.prototype.unloadTile.call(this,e,(o=>{const{x:i,y:r,z:a}=e.tileID.canonical,s=`${a}/${i}/${r}`,n=e._boxMesh,l=e._rainMesh,h=e._snowMesh;n&&(n.parent.remove(n),$(n),delete e._boxMesh),l&&(l.parent.remove(l),$(l),delete e._rainMesh),h&&(h.parent.remove(h),$(h),delete e._snowMesh),delete this._tileDict[s],t(o)}))}class Z extends t{constructor(e){super(),this.id=e.id,this.type="custom",this.renderingMode="3d",this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,this.source=e.source||"rainviewer",this.scale=e.scale||"noaa",this.rainColor=e.rainColor||"#ccf",this.snowColor=e.snowColor||"#fff",this.meshOpacity=E(e.meshOpacity,.1),this.repaint=E(e.repaint,!0),this._interval=x[this.source].interval,this._colors=x[this.source].colors,this._onZoom=this._onZoom.bind(this)}onAdd(e,t){this._parseColor=e.painter.context.clearColor.default.constructor.parse,this._scene=new w,this._camera=new s,this._directionalLight=new l(16777215),this._directionalLight.position.set(0,-70,100).normalize(),this._scene.add(this._directionalLight),this._ambientLight=new i(16777215,.4),this._scene.add(this._ambientLight),this._meshMaterial=new _({opacity:this.meshOpacity,transparent:this.meshOpacity<1});let o=this._parseColor(this.rainColor);this._rainMaterial=new v({uniforms:{time:{type:"f",value:0},scale:{type:"f",value:1},color:{type:"v4",value:new y(o.r,o.g,o.b,o.a)}},vertexShader:A,fragmentShader:S,transparent:o.a<1,side:h}),o=this._parseColor(this.snowColor),this._snowMaterial=new v({uniforms:{time:{type:"f",value:0},scale:{type:"f",value:1},color:{type:"v4",value:new y(o.r,o.g,o.b,o.a)}},vertexShader:A,fragmentShader:S,transparent:o.a<1,side:h}),this._baseZoom=Math.round(e.getZoom()),this._zoomGroups=[];for(let e=0;e<=24;e++)this._zoomGroups[e]=new c,this._zoomGroups[e].visible=e===this._baseZoom,this._scene.add(this._zoomGroups[e]);const{scale:r,align:a}=g[this.scale];this._scaleColors=r.map((({value:e,color:t},o,i)=>{if("center"===a){e=(e+(o<i.length-1?i[o+1].value:1/0))/2}return[e+32,new n(t)]})),this._map=e,this._map.setLayerZoomRange(this.id,this.minzoom,this.maxzoom),this._map.on("zoom",this._onZoom),this._renderer=new M({canvas:e.getCanvas(),context:t,antialias:!0}),this._renderer.autoClear=!1,this._refreshSource(),this._timer=setInterval(this._refreshSource.bind(this),this._interval)}onRemove(){delete this._parseColor,this._scene.remove(this._directionalLight),this._directionalLight.dispose(),delete this._directionalLight,this._scene.remove(this._ambientLight),this._ambientLight.dispose(),delete this._ambientLight,this._meshMaterial.dispose(),delete this._meshMaterial,this._rainMaterial.dispose(),delete this._rainMaterial,delete this._baseZoom;for(let e=0;e<=24;e++)this._scene.remove(this._zoomGroups[e]);delete this._zoomGroups,delete this._scaleColors,delete this._camera,delete this._scene,this._renderer.dispose(),delete this._renderer,this._map.off("zoom",this._onZoom),this._removeSource(),delete this._map,clearInterval(this._timer),delete this._timer}render(e,t){const o=this._map.getZoom();this._rainMaterial.uniforms.time.value=6e-4*performance.now(),this._rainMaterial.uniforms.scale.value=Math.pow(2,this._baseZoom-o-(o>=10.5?1:0)),this._snowMaterial.uniforms.time.value=15e-5*performance.now(),this._snowMaterial.uniforms.scale.value=Math.pow(2,this._baseZoom-o-(o>=10.5?1:0)),this._camera.projectionMatrix=(new f).fromArray(t),this._renderer.resetState(),this._renderer.render(this._scene,this._camera),this.repaint&&this._map.triggerRepaint()}_onZoom(){this._baseZoom=Math.round(this._map.getZoom());for(let e=0;e<=24;e++)this._zoomGroups[e].visible=e===this._baseZoom}_refreshSource(){const e=this.source,{tiles:t,tileSize:o,minzoom:i,maxzoom:r,attribution:a,catalog:s,timestamp:n}=x[e];fetch(s).then((e=>e.json())).then((s=>{const l=this._map;this._removeSource(),l.addSource(e,{type:"raster",tiles:t.map((e=>B(e,s))),tileSize:o,minzoom:i,maxzoom:r,attribution:a});const h=l.getSource(e);h._parentLayer=this,h._tileDict={},h.loadTile=j,h.unloadTile=D,l.addLayer({id:e,type:"raster",source:e,paint:{"raster-opacity":0}},this.id),this.fire({type:"refresh",timestamp:+B(n,s)})}))}_removeSource(){const e=this.source,t=this._map,o=t.getSource(e);o&&(t.removeLayer(e),t.removeSource(e),delete o._parentLayer)}setRainColor(e){if(this.rainColor=e||"#ccf",this._parseColor&&this._rainMaterial){const{r:e,g:t,b:o,a:i}=this._parseColor(this.rainColor);this._rainMaterial.uniforms.color.value=new y(e,t,o,i),this._rainMaterial.transparent=i<1}return this}setSnowColor(e){if(this.snowColor=e||"#fff",this._parseColor&&this._snowMaterial){const{r:e,g:t,b:o,a:i}=this._parseColor(this.snowColor);this._snowMaterial.uniforms.color.value=new y(e,t,o,i),this._snowMaterial.transparent=i<1}return this}setMeshOpacity(e){return this.meshOpacity=E(e,.1),this._meshMaterial&&(this._meshMaterial.opacity=e,this._meshMaterial.transparent=e<1),this}getLegendHTML(){return['<div style="font-size: 10px; line-height: 14px;"><div>dBZ</div>',...g[this.scale].scale.slice(1).reverse().map((e=>`\n                <div>\n                    <div style="display: inline-block; vertical-align: top; width: 14px; height: 14px; background-color: ${e.color}; border: solid 0.5px #aaa;"></div>\n                    <div style="display: inline-block; vertical-align: top;">${e.value}</div>\n                </div>\n            `)),"</div>"].join("")}}function k(e,t){const o=t.replace("#","%23");return e.replace("%3e",` fill='${o}' stroke='${o}'%3e`)}class T{constructor(){const e=this;e.id="precipitation",e.name={en:"Precipitation",ja:"降水",ko:"강수",ne:"वर्षा",pt:"Precipitação",th:"ฝน","zh-Hans":"降水","zh-Hant":"降水"},e.iconStyle={backgroundSize:"32px",backgroundImage:`url("${k("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3e%3c!-- Font Awesome Free 5.15.4 by %40fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0%2c Fonts: SIL OFL 1.1%2c Code: MIT License) --%3e%3cpath d='M183.9 370.1c-7.6-4.4-17.4-1.8-21.8 6l-64 112c-4.4 7.7-1.7 17.5 6 21.8 2.5 1.4 5.2 2.1 7.9 2.1 5.5 0 10.9-2.9 13.9-8.1l64-112c4.4-7.6 1.7-17.4-6-21.8zm96 0c-7.6-4.4-17.4-1.8-21.8 6l-64 112c-4.4 7.7-1.7 17.5 6 21.8 2.5 1.4 5.2 2.1 7.9 2.1 5.5 0 10.9-2.9 13.9-8.1l64-112c4.4-7.6 1.7-17.4-6-21.8zm-192 0c-7.6-4.4-17.4-1.8-21.8 6l-64 112c-4.4 7.7-1.7 17.5 6 21.8 2.5 1.4 5.2 2.1 7.9 2.1 5.5 0 10.9-2.9 13.9-8.1l64-112c4.4-7.6 1.7-17.4-6-21.8zm384 0c-7.6-4.4-17.4-1.8-21.8 6l-64 112c-4.4 7.7-1.7 17.5 6 21.8 2.5 1.4 5.2 2.1 7.9 2.1 5.5 0 10.9-2.9 13.9-8.1l64-112c4.4-7.6 1.7-17.4-6-21.8zm-96 0c-7.6-4.4-17.4-1.8-21.8 6l-64 112c-4.4 7.7-1.7 17.5 6 21.8 2.5 1.4 5.2 2.1 7.9 2.1 5.5 0 10.9-2.9 13.9-8.1l64-112c4.4-7.6 1.7-17.4-6-21.8zM416 128c-.6 0-1.1.2-1.6.2 1.1-5.2 1.6-10.6 1.6-16.2 0-44.2-35.8-80-80-80-24.6 0-46.3 11.3-61 28.8C256.4 24.8 219.3 0 176 0 114.2 0 64 50.1 64 112c0 7.3.8 14.3 2.1 21.2C27.8 145.8 0 181.5 0 224c0 53 43 96 96 96h320c53 0 96-43 96-96s-43-96-96-96z'/%3e%3c/svg%3e","white")}")`},e.clockModes=["realtime"],e.viewModes=["ground"],e.layer=new Z({id:e.id,rainColor:"#00f",meshOpacity:0,repaint:!1}),e._onRefresh=e._onRefresh.bind(e)}onAdd(e){this.map=e,e.addLayer(this.layer)}onRemove(e){e.removeLayer(this.id)}onEnabled(){const e=this;e.layer.on("refresh",e._onRefresh),e._onRefresh()}onDisabled(){this.layer.off("refresh",this._onRefresh)}onVisibilityChanged(e){this.map.setLayerVisibility(this.id,e?"visible":"none")}_onRefresh(){const e=this;e.layer.setRainColor(e.map.hasDarkBackground()?"#ccf":"#00f"),e.layer.setSnowColor(e.map.hasDarkBackground()?"#fff":"#ccf")}}return function(){return new T}}));
//# sourceMappingURL=mt3d-plugin-precipitation.min.js.map
